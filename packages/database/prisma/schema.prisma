// DrivePark — source of truth
// PostgreSQL + PostGIS for geo (extensions enabled in migration)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ——— Roles & Auth ———
enum Role {
  CLIENT
  HOST
  DRIVER
  ADMIN
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  passwordHash  String?
  role          Role      @default(CLIENT)
  firstName     String?
  lastName      String?
  avatarUrl     String?
  phone         String?
  preferredLang String    @default("en")
  profileData   Json?     // preferredName, hostDisplayName, residentialAddress, postalAddress, emergencyContacts
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  listings      Listing[]
  bookingsAsGuest   Booking[] @relation("GuestBookings")
  bookingsAsHost    Booking[] @relation("HostBookings")
  reviewsWritten    Review[]  @relation("AuthorReviews")
  reviewsReceived   Review[]  @relation("SubjectReviews")
  messagesSent      Message[] @relation("SenderMessages")
  messagesReceived  Message[] @relation("ReceiverMessages")
  kycVerifications  KycVerification[]
  notifications     Notification[]
  auditLogs         AuditLog[]
  hostPayouts       HostPayout[]
  adminActions      AdminAction[]
  stripeAccountId   String?  // ID du compte Stripe Connect de l'hôte
}

// ——— OTP (passwordless login / signup) ———
model OtpRequest {
  id        String   @id @default(cuid())
  email     String?  // primary for now; SMS later
  phone     String?
  code      String   // 6 digits
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([phone])
  @@index([expiresAt])
}

// ——— Password reset (forgot password flow) ———
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

// ——— KYC / Trust ———
model KycVerification {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  status        String    // PENDING, PENDING_REVIEW, APPROVED, REJECTED
  firstName     String?
  lastName      String?
  dateOfBirth   DateTime? @db.Date
  nationality   String?
  documentType  String?   // id_card | passport
  idDocUrl      String?
  idDocBackUrl  String?
  licenseUrl    String?
  reviewReason  String?   // DOUBTFUL | MISMATCH | ILLEGIBLE | SUSPECTED_FRAUD
  ocrPayload    Json?
  verifiedAt    DateTime?
  reviewedBy    String?
  rejectionReason String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// ——— Geographic (source of truth for SEO) ———
model Country {
  id        String   @id @default(cuid())
  code      String   @unique // ISO 3166-1 (FR, DE, ES...)
  slug      String   @unique
  name      Json     // {en: "France", fr: "France"}
  mediaUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  regions   Region[]
  cities    City[]
}

model Region {
  id        String   @id @default(cuid())
  countryId String
  country   Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  slug      String
  name      Json
  mediaUrl  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cities    City[]

  @@unique([countryId, slug])
  @@index([countryId])
}

model City {
  id           String   @id @default(cuid())
  regionId     String?
  region       Region?  @relation(fields: [regionId], references: [id], onDelete: SetNull)
  countryId    String
  country      Country  @relation(fields: [countryId], references: [id], onDelete: Cascade)
  slug         String
  name         Json
  latitude     Float?
  longitude    Float?
  seoPriority  Int      @default(0) // 0 = auto, >0 = strategic city (override possible)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  listings     Listing[]

  @@unique([countryId, slug])
  @@index([countryId])
  @@index([regionId])
  @@index([seoPriority])
}

// ——— SEO templates & overrides ———
model SeoTemplate {
  id       String   @id @default(cuid())
  vertical String   // location | experience | ride
  scope    String   // city | region | country | listing
  key      String   // title | description | h1
  template String   @db.Text // "Louer une voiture à {{cityName}} | DrivePark"
  variants Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vertical, scope, key])
}

model SeoOverride {
  id         String   @id @default(cuid())
  entityType String   // city | region | country
  entityId   String
  vertical   String
  key        String   // title | description
  value      String   @db.Text

  @@unique([entityType, entityId, vertical, key])
  @@index([entityType, entityId])
}

model MediaAsset {
  id         String   @id @default(cuid())
  entityType String   // city | region | country | category
  entityId   String?
  vertical   String?  // null = generic
  url        String
  type       String   // image | hero

  @@index([entityType, entityId])
}

// ——— Vehicle Identity (make/model, VIN, specs) ———
enum FuelType {
  petrol
  diesel
  electric
  hybrid
  lpg
  other
}

enum TransmissionType {
  manual
  automatic
  semi_automatic
  cvt
  other
}

enum DriveType {
  fwd
  rwd
  awd
  other
}

enum ReferenceStatus {
  verified
  unverified
}

enum SpecSource {
  system
  host_confirmed
  host_manual
}

model Make {
  id             String           @id @default(cuid())
  name           String
  slug           String           @unique
  externalSource String?
  externalId     String?
  status         ReferenceStatus   @default(verified)

  @@index([slug])
  @@index([status])
  aliases   MakeAlias[]
  models    Model[]
  vehicles  Vehicle[]
}

model MakeAlias {
  id              String   @id @default(cuid())
  makeId          String
  make            Make     @relation(fields: [makeId], references: [id], onDelete: Cascade)
  alias           String
  normalizedAlias String

  @@unique([makeId, normalizedAlias])
  @@index([normalizedAlias])
}

model Model {
  id             String           @id @default(cuid())
  makeId         String
  make           Make             @relation(fields: [makeId], references: [id], onDelete: Cascade)
  name           String
  slug           String
  status         ReferenceStatus   @default(verified)
  externalSource String?
  externalId     String?

  @@unique([makeId, slug])
  @@index([makeId])
  @@index([status])
  aliases  ModelAlias[]
  vehicles Vehicle[]
}

model ModelAlias {
  id              String @id @default(cuid())
  modelId         String
  model           Model  @relation(fields: [modelId], references: [id], onDelete: Cascade)
  alias           String
  normalizedAlias String

  @@unique([modelId, normalizedAlias])
  @@index([normalizedAlias])
}

enum OwnerType {
  PARTICULAR
  PROFESSIONAL
}

model Vehicle {
  id                   String             @id @default(cuid())
  vin                  String             @unique
  makeId               String
  make                 Make               @relation(fields: [makeId], references: [id], onDelete: Restrict)
  modelId              String
  model                Model              @relation(fields: [modelId], references: [id], onDelete: Restrict)
  modelYear            Int
  trimLabel            String?
  fuelType             FuelType?
  transmissionType     TransmissionType?
  driveType            DriveType?
  topSpeedKmh          Int?
  zeroTo100S           Decimal?           @db.Decimal(5, 2)
  powerKw              Decimal?           @db.Decimal(6, 2)
  powerCv              Int?               // Puissance en CV (thermique/hybride)
  batteryKwh           Decimal?           @db.Decimal(5, 2) // Capacité batterie KWh (électrique)
  registrationCountry  String?            // Pays d'immatriculation (ISO code)
  licensePlate         String?            // Plaque d'immatriculation
  fiscalPower          Int?               // Puissance fiscale
  ownerType            OwnerType?         // Particulier ou professionnel
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  @@index([vin])
  @@index([makeId])
  @@index([modelId])
  specMeta      VehicleSpecMeta[]
  fieldAudit    VehicleFieldAudit[]
  listings      Listing[]
  availability  VehicleAvailability[]
}

model VehicleSpecMeta {
  id         String    @id @default(cuid())
  vehicleId  String
  vehicle    Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  specKey    String    // power_kw, fuel_type, top_speed_kmh, zero_to_100_s, transmission_type, drive_type
  source     SpecSource
  confidence Decimal   @db.Decimal(3, 2) // 0-1
  needsReview Boolean  @default(false)
  updatedAt  DateTime @updatedAt

  @@unique([vehicleId, specKey])
  @@index([vehicleId])
}

model VehicleFieldAudit {
  id        String   @id @default(cuid())
  vehicleId String
  vehicle   Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  fieldName String
  oldValue  String?  @db.Text
  newValue  String?  @db.Text
  source    String?
  userId    String?
  createdAt DateTime @default(now())

  @@index([vehicleId])
  @@index([fieldName])
  @@index([createdAt])
}

// ——— Listings (voiture, expérience, chauffeur) ———
enum ListingType {
  CAR_RENTAL      // self-drive
  MOTORIZED_EXPERIENCE
  CHAUFFEUR
}

model Category {
  id        String      @id @default(cuid())
  name      String      // Nom de la catégorie
  slug      String      // Slug unique pour l'URL
  vertical  ListingType // CAR_RENTAL | MOTORIZED_EXPERIENCE | CHAUFFEUR
  imageUrl  String?     // URL de l'image de la catégorie
  order     Int         @default(0) // Ordre d'affichage
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  listings  ListingCategory[]   // Relation many-to-many avec les listings
  
  @@unique([vertical, slug])
  @@index([vertical])
}

model Listing {
  id          String      @id @default(cuid())
  type        ListingType
  hostId      String
  host        User        @relation(fields: [hostId], references: [id], onDelete: Cascade)
  title       String?     // legacy; when vehicleId set, use displayName
  displayName String?     // canonical from vehicle (make model year trim)
  slug        String      @unique
  description String?
  status      String      @default("DRAFT") // DRAFT, PENDING, ACTIVE, SUSPENDED

  vehicleId   String?
  vehicle     Vehicle?    @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  // Categories: many-to-many relation
  categories  ListingCategory[]

  // Geo (PostGIS: use raw SQL or Prisma extension for point)
  cityId      String?
  cityRef     City?    @relation(fields: [cityId], references: [id], onDelete: SetNull)
  latitude    Float?
  longitude   Float?
  city        String?  // legacy fallback during migration
  country     String?
  address     String?

  // Pricing
  pricePerDay Decimal?    @db.Decimal(10, 2)
  currency    String      @default("EUR")
  caution     Decimal?    @db.Decimal(10, 2)
  cancellationPolicy String?

  // Booking rules
  minBookingNoticeHours Int?      // Délai minimum de préavis (heures)
  maxBookingAdvanceDays Int?      // Délai maximum de réservation à l'avance (jours)
  instantBooking Boolean @default(false) // Réservation instantanée
  manualApprovalRequired Boolean @default(false) // Validation manuelle obligatoire
  minRentalDurationHours Int?     // Durée minimale de location (heures)
  maxRentalDurationDays Int?      // Durée maximale de location (jours)
  autoAcceptBookings Boolean @default(false) // Acceptation automatique

  // Renter conditions
  minDriverAge Int?       // Âge minimum du conducteur
  minLicenseYears Int?    // Nombre minimum d'années de permis

  // Car-specific / Listing config (seats, doors, luggage when vehicleId present)
  transmission String?    // legacy; prefer vehicle.transmissionType
  fuelType    String?     // legacy; prefer vehicle.fuelType
  seats       Int?
  doors       Int?
  luggage     Int?
  options     Json?       // extra options: availability, pricing, usageConditions, insurance, returnRules, penalties

  // Experience / Chauffeur
  durationMinutes Int?
  maxParticipants Int?
  driverId    String?     // for chauffeur

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  photos           ListingPhoto[]
  availabilities   ListingAvailability[]
  bookings        Booking[]
  reviews         Review[]
  insurancePolicies ListingInsurancePolicy[]
}

// ——— Listing-Category (many-to-many) ———
model ListingCategory {
  id         String   @id @default(cuid())
  listingId  String
  listing    Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([listingId, categoryId])
  @@index([listingId])
  @@index([categoryId])
}

// ——— Assurances ———
model Insurer {
  id       String   @id @default(cuid())
  name     String
  status   String   @default("ACTIVE") // ACTIVE | INACTIVE
  policies InsurancePolicy[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
}

model InsurancePolicy {
  id                 String   @id @default(cuid())
  insurerId          String
  insurer            Insurer  @relation(fields: [insurerId], references: [id], onDelete: Cascade)
  name               String
  eligibilityCriteria Json    // vehicleYearMin/Max, minDriverAge, minLicenseYears, fiscalPowerMin/Max, allowedCountries[], registrationCountries[], ownerTypes[], secondaryDriverAllowed
  details            Json     // cautionAmount, assistance0km, roadsideAssistance, personalEffectsProtection, compensationCeiling, minRentalDays, maxRentalDays
  status             String   @default("ACTIVE") // ACTIVE | INACTIVE
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  listings ListingInsurancePolicy[]
  markets  MarketInsurancePolicy[]

  @@index([insurerId])
  @@index([status])
}

enum MarketStatus {
  DRAFT
  ACTIVE
  PAUSED
}

model Market {
  id                  String       @id @default(cuid())
  countryCode         String       @unique
  displayName         String
  status              MarketStatus @default(DRAFT)
  visibleToClient     Boolean      @default(false)
  bookingsAllowed     Boolean      @default(false)
  defaultCurrency     String?
  defaultLanguage     String?
  allowedLanguages    Json         // ["fr", "en"]
  allowedCurrencies   Json         // ["EUR"]
  paymentProvider     String?
  paymentMethods      Json?
  commissionPercent   Decimal?     @db.Decimal(5, 2)
  taxesEnabled        Boolean      @default(false)
  vatIncluded         Boolean      @default(true)
  defaultVatRate      Decimal?     @db.Decimal(5, 2)
  invoiceLegalMention String?      @db.Text
  seoIndexable        Boolean      @default(true)
  internalNote        String?      @db.Text
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  policyLinks         MarketInsurancePolicy[]

  @@index([status])
  @@index([countryCode])
}

model MarketInsurancePolicy {
  id               String          @id @default(cuid())
  marketId         String
  market           Market          @relation(fields: [marketId], references: [id], onDelete: Cascade)
  insurancePolicyId String
  insurancePolicy  InsurancePolicy  @relation(fields: [insurancePolicyId], references: [id], onDelete: Cascade)
  isDefault        Boolean         @default(false)
  createdAt        DateTime        @default(now())

  @@unique([marketId, insurancePolicyId])
  @@index([marketId])
  @@index([insurancePolicyId])
}

model ListingInsurancePolicy {
  id               String   @id @default(cuid())
  listingId        String
  listing          Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  insurancePolicyId String
  insurancePolicy  InsurancePolicy @relation(fields: [insurancePolicyId], references: [id], onDelete: Cascade)
  createdAt        DateTime @default(now())

  @@unique([listingId, insurancePolicyId])
  @@index([listingId])
  @@index([insurancePolicyId])
}

model ListingPhoto {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())
}

// Availability at vehicle level: one calendar per vehicle; shared by all listings that use this vehicle (e.g. location + chauffeur).
model VehicleAvailability {
  id            String    @id @default(cuid())
  vehicleId     String
  vehicle       Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  date          DateTime  @db.Date
  available     Boolean   @default(true)
  priceOverride Decimal?  @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([vehicleId, date])
  @@index([vehicleId, date])
}

model ListingAvailability {
  id        String   @id @default(cuid())
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id], onDelete: Cascade)
  date      DateTime @db.Date
  available Boolean  @default(true)
  priceOverride Decimal? @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([listingId, date])
  @@index([listingId, date])
}

// ——— Inspections & Damage Claims ———
enum InspectionType {
  DEPART
  RETOUR
}

enum InspectionMode {
  MAIN_PROPRE
  BOITE_A_CLES
}

enum InspectionCreator {
  HOST
  RENTER
}

enum InspectionStatus {
  DRAFT
  SUBMITTED
  VALIDATED
  CONTESTED
  EXPIRED
}

enum ConditionStatus {
  OK
  MINOR_ISSUE
  MAJOR_ISSUE
}

enum CleanlinessLevel {
  CLEAN
  LIGHT_DIRT
  DIRTY
  VERY_DIRTY
}

enum DamageClaimStatus {
  DRAFT
  SUBMITTED
  AWAITING_RENTER_RESPONSE
  RENTER_ACCEPTED
  RENTER_CONTESTED
  AWAITING_ADMIN_REVIEW
  ADMIN_APPROVED
  ADMIN_ADJUSTED
  ADMIN_REJECTED
  CLOSED
}

enum DepositStatus {
  PREAUTHORIZED
  HELD
  UNDER_REVIEW
  RELEASED
  CAPTURE_REQUESTED
  CAPTURED_PARTIAL
  CAPTURED_FULL
}

// ——— Bookings ———
enum BookingStatus {
  PENDING
  PENDING_APPROVAL  // Pré-autorisation effectuée, en attente d'approbation host (manuel)
  CONFIRMED
  CANCELLED
  COMPLETED
  IN_PROGRESS
}

model Booking {
  id            String        @id @default(cuid())
  listingId     String
  listing       Listing       @relation(fields: [listingId], references: [id])
  guestId       String
  guest         User          @relation("GuestBookings", fields: [guestId], references: [id])
  hostId        String
  host          User          @relation("HostBookings", fields: [hostId], references: [id])

  status        BookingStatus @default(PENDING)
  startAt       DateTime
  endAt         DateTime
  totalAmount   Decimal       @db.Decimal(10, 2)
  currency      String        @default("EUR")
  cautionAmount Decimal?      @db.Decimal(10, 2)
  options       Json?         // selected options, insurance

  checkInAt     DateTime?
  checkOutAt    DateTime?
  notes         String?

  approvalDeadline DateTime?  // Date limite d'approbation pour réservations manuelles
  approvalExpired  Boolean    @default(false) // Flag pour éviter double traitement
  handoverMode     InspectionMode? // MAIN_PROPRE | BOITE_A_CLES — défini au checkout

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  payments           Payment[]
  messages           Message[]
  review             Review?
  hostPayout         HostPayout?
  inspections        Inspection[]
  damageClaims       DamageClaim[]
  deposit            Deposit?
  inspectionTimeline InspectionTimelineEvent[]
}

// ——— Payments (Stripe-oriented) ———
enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

model Payment {
  id            String        @id @default(cuid())
  bookingId     String
  booking       Booking      @relation(fields: [bookingId], references: [id])
  amount        Decimal      @db.Decimal(10, 2)
  currency      String       @default("EUR")
  status        PaymentStatus @default(PENDING)
  stripePaymentId String?    @unique
  type          String       // booking, caution, extra, refund
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  auditLogs     PaymentAuditLog[]
  deposit       Deposit?

  @@index([bookingId])
  @@index([stripePaymentId])
  @@index([bookingId, type, status])
  // Note: Contrainte unique partielle (bookingId, type, status) pour status=PENDING
  // sera créée via migration SQL car Prisma ne supporte pas les contraintes uniques partielles directement
}

// ——— Messaging ———
model Message {
  id         String   @id @default(cuid())
  bookingId  String?
  booking    Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  senderId   String
  sender     User     @relation("SenderMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceiverMessages", fields: [receiverId], references: [id])
  body       String
  readAt     DateTime?
  createdAt  DateTime @default(now())
  attachments MessageAttachment[]

  @@index([bookingId])
  @@index([senderId, receiverId])
}

model MessageAttachment {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  url       String
  type      String   // "image" | "file"
  filename  String?
  createdAt DateTime @default(now())

  @@index([messageId])
}

// ——— Reviews ———
model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique
  booking   Booking  @relation(fields: [bookingId], references: [id])
  listingId String
  listing   Listing  @relation(fields: [listingId], references: [id])
  authorId  String
  author    User     @relation("AuthorReviews", fields: [authorId], references: [id])
  subjectId String   // host or guest being reviewed
  subject   User     @relation("SubjectReviews", fields: [subjectId], references: [id])
  rating    Int      // 1-5
  comment   String?
  hostReply String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([listingId])
  @@index([subjectId])
}

// ——— Notifications ———
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String
  title     String
  body      String?
  data      Json?    // deep link, etc.
  readAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
}

// ——— Admin audit ———
model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String
  resource   String
  resourceId String?
  metadata   Json?
  ip         String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([resource, resourceId])
  @@index([createdAt])
}

// ——— Admin settings (API keys, tokens, etc.) ———
model Setting {
  id        String   @id @default(cuid())
  key       String   @unique  // e.g. STRIPE_SECRET_KEY, GOOGLE_CLIENT_ID
  value     String   @db.Text // stored as plain; consider encryption for production
  category  String?  // stripe, google, apple, smtp, etc.
  updatedAt DateTime @updatedAt

  @@index([category])
}

// ——— Host Payouts ———
enum PayoutStatus {
  PENDING       // En attente (réservation pas encore terminée)
  SCHEDULED     // Programmé pour versement (après endAt)
  PROCESSING    // Transfert Stripe en cours
  PAID          // Versé à l'hôte
  FAILED        // Échec du transfert
  CANCELLED     // Annulé (si réservation annulée avant versement)
}

model HostPayout {
  id              String        @id @default(cuid())
  bookingId       String        @unique
  booking         Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  hostId          String
  host            User          @relation(fields: [hostId], references: [id])
  
  totalAmount     Decimal       @db.Decimal(10, 2)  // Montant total réservation
  commissionAmount Decimal      @db.Decimal(10, 2)  // 15% commission plateforme
  hostAmount      Decimal       @db.Decimal(10, 2)  // 85% versé à l'hôte
  
  currency        String        @default("EUR")
  status          PayoutStatus  @default(PENDING)
  stripeTransferId String?      @unique  // ID du transfer Stripe
  
  scheduledAt     DateTime?     // Date prévue (après endAt)
  paidAt          DateTime?     // Date effective
  metadata        Json?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([hostId])
  @@index([status])
  @@index([scheduledAt])
}

// ——— Payment Audit Log ———
model PaymentAuditLog {
  id          String   @id @default(cuid())
  paymentId   String
  payment     Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  action      String   // refund, retry, cancel, override_amount, status_change
  actorId     String
  actorType   String   // admin, system, webhook
  oldValue    Json?    // État avant modification
  newValue    Json?    // État après modification
  reason      String?  // Raison de la modification
  metadata    Json?    // Données supplémentaires (stripeResponse, etc.)
  createdAt   DateTime @default(now())
  
  @@index([paymentId])
  @@index([actorId])
  @@index([action])
  @@index([createdAt])
}

// ——— Payment Settings ———
model PaymentSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       Json     // Valeur configurable
  description String?  // Description de la config
  updatedBy   String?  // Admin qui a modifié
  updatedAt   DateTime @updatedAt
}

// ——— Admin Actions ———
model AdminAction {
  id          String   @id @default(cuid())
  adminId     String
  admin       User     @relation(fields: [adminId], references: [id])
  action      String   // refund_payment, force_payout, override_commission, etc.
  resource    String   // Payment, HostPayout, Booking
  resourceId String
  details     Json     // Détails de l'action
  result      String?  // success, failed, pending
  error       String?  // Message d'erreur si échec
  createdAt   DateTime @default(now())
  
  @@index([adminId])
  @@index([resource, resourceId])
  @@index([action])
  @@index([createdAt])
}

// ——— Inspections (état des lieux) ———
model Inspection {
  id                  String           @id @default(cuid())
  bookingId           String
  booking             Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  type                InspectionType
  mode                InspectionMode
  createdBy           InspectionCreator
  delegated           Boolean          @default(false)
  status              InspectionStatus @default(DRAFT)
  mileageValue        Int?
  energyLevelPercent  Int?
  documentsPresent    Json?
  accessoriesChecklist Json?
  dashboardWarnings   Json?
  metadata            Json?
  contentHash         String?
  validatedAt         DateTime?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  items InspectionItem[]

  @@index([bookingId])
  @@index([bookingId, type])
}

model InspectionItem {
  id               String           @id @default(cuid())
  inspectionId     String
  inspection       Inspection       @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  itemCode         String
  photoStepCode    String
  photoUrl         String?
  conditionStatus  ConditionStatus
  conditionNote    String?
  cleanlinessLevel CleanlinessLevel
  cleanlinessNote  String?
  detailCloseups   Json?
  order            Int

  @@unique([inspectionId, itemCode])
  @@index([inspectionId])
}

model DamageClaim {
  id               String            @id @default(cuid())
  bookingId        String
  booking          Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  createdBy        String
  status           DamageClaimStatus  @default(DRAFT)
  category         String
  zoneCoords       Json?
  amountRequested  Decimal           @db.Decimal(10, 2)
  justification   String            @db.Text
  quoteUrl        String?
  departPhotoUrl   String
  returnPhotoUrl  String
  submittedAt      DateTime?
  renterResponse   String?
  renterResponseAt DateTime?
  adminDecision   String?
  adminAmount     Decimal?          @db.Decimal(10, 2)
  adminNote       String?           @db.Text
  adminDecidedAt  DateTime?
  adminId         String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([bookingId])
}

model Deposit {
  id        String       @id @default(cuid())
  bookingId String       @unique
  booking   Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  paymentId String       @unique
  payment   Payment      @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  status    DepositStatus @default(PREAUTHORIZED)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([bookingId])
}

model InspectionTimelineEvent {
  id        String   @id @default(cuid())
  bookingId String
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  eventType String
  payload   Json?
  createdAt DateTime @default(now())

  @@index([bookingId])
  @@index([bookingId, eventType])
}

model InspectionScoring {
  id                     String    @id @default(cuid())
  bookingId              String?
  inspectionId           String?
  damageClaimId          String?
  inspectionQualityScore Int?
  hostReliabilityScore   Int?
  renterReliabilityScore Int?
  claimConfidenceScore   Int?
  computedAt             DateTime  @default(now())

  @@index([bookingId])
  @@index([inspectionId])
  @@index([damageClaimId])
}
